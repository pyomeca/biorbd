import numpy as np
import pytest

from wrapper_tests_utils import evaluate, brbd_to_test


@pytest.mark.parametrize("brbd", brbd_to_test)
def test_wrapper_model(brbd):
    model = brbd.Biorbd("../../models/pyomecaman.bioMod")

    # Generic properties
    assert model.name == "pyomecaman"
    assert model.path == "../../models/pyomecaman.bioMod"

    # Gravity
    np.testing.assert_almost_equal(evaluate(brbd, model.gravity), [0, 0, -9.81])
    model.gravity = [1, 2, 3]
    np.testing.assert_almost_equal(evaluate(brbd, model.gravity), [1, 2, 3])

    # Mass
    assert evaluate(brbd, model.mass) == 52.41212

    # Center of mass
    q = [0.1] * model.nb_q
    np.testing.assert_almost_equal(evaluate(brbd, model.center_of_mass, q=q), [-0.0007778, 0.12675668, 0.0568666])
    if brbd.backend == brbd.CASADI:
        with pytest.raises(
            RuntimeError,
            match="The 'center_of_mass' method without setting q cannot be called when using the CasADi backend",
        ):
            model.center_of_mass()
    else:
        np.testing.assert_almost_equal(model.center_of_mass(), [-0.0007778, 0.12675668, 0.0568666])

    # Mass matrix
    mass_matrix_reference = [
        [
            5.24121200e01,
            0.00000000e00,
            2.26071317e00,
            6.61861232e-02,
            5.14976862e-01,
            -1.06748438e-01,
            5.14976862e-01,
            3.15903463e00,
            7.35528935e-01,
            -1.86325616e-02,
            3.15903463e00,
            7.35528935e-01,
            -1.86325616e-02,
        ],
        [
            0.00000000e00,
            5.24121200e01,
            1.40237437e00,
            6.64076297e-03,
            2.56865141e-01,
            -1.07105695e-02,
            2.56865141e-01,
            1.46647191e00,
            4.77016896e-01,
            5.07605942e-02,
            1.46647191e00,
            4.77016896e-01,
            5.07605942e-02,
        ],
        [
            2.26071317e00,
            1.40237437e00,
            7.58496132e00,
            -5.89988646e-03,
            2.23878926e-02,
            7.77413697e-03,
            2.08987116e-02,
            2.12586831e00,
            6.71356845e-01,
            8.88006475e-03,
            2.12586831e00,
            6.71356845e-01,
            8.88006475e-03,
        ],
        [
            6.61861232e-02,
            6.64076297e-03,
            -5.89988646e-03,
            2.28756926e-02,
            1.97535734e-02,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            5.14976862e-01,
            2.56865141e-01,
            2.23878926e-02,
            1.97535734e-02,
            2.08469103e-01,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            -1.06748438e-01,
            -1.07105695e-02,
            7.77413697e-03,
            0.00000000e00,
            0.00000000e00,
            2.28756926e-02,
            -1.97535734e-02,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            5.14976862e-01,
            2.56865141e-01,
            2.08987116e-02,
            0.00000000e00,
            0.00000000e00,
            -1.97535734e-02,
            2.08469103e-01,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            3.15903463e00,
            1.46647191e00,
            2.12586831e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            1.78500753e00,
            5.88843487e-01,
            9.51033936e-03,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            7.35528935e-01,
            4.77016896e-01,
            6.71356845e-01,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            5.88843487e-01,
            2.53054659e-01,
            8.75591123e-03,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            -1.86325616e-02,
            5.07605942e-02,
            8.88006475e-03,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            9.51033936e-03,
            8.75591123e-03,
            5.72188133e-03,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
        ],
        [
            3.15903463e00,
            1.46647191e00,
            2.12586831e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            1.78500753e00,
            5.88843487e-01,
            9.51033936e-03,
        ],
        [
            7.35528935e-01,
            4.77016896e-01,
            6.71356845e-01,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            5.88843487e-01,
            2.53054659e-01,
            8.75591123e-03,
        ],
        [
            -1.86325616e-02,
            5.07605942e-02,
            8.88006475e-03,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            0.00000000e00,
            9.51033936e-03,
            8.75591123e-03,
            5.72188133e-03,
        ],
    ]
    np.testing.assert_almost_equal(evaluate(brbd, model.mass_matrix, q=q), mass_matrix_reference)
    if brbd.backend == brbd.CASADI:
        with pytest.raises(
            RuntimeError,
            match="The 'mass_matrix' method without setting q cannot be called when using the CasADi backend",
        ):
            model.mass_matrix()
    else:
        np.testing.assert_almost_equal(model.mass_matrix(), mass_matrix_reference)

    inverse_matrix_reference = [
        [
            5.07984184e-02,
            1.23127703e-02,
            1.26540632e-01,
            1.66438320e-02,
            -1.55823978e-01,
            7.34011557e-02,
            -1.46387797e-01,
            -3.61205434e-01,
            3.35786798e-01,
            -5.36748334e-02,
            -3.61205434e-01,
            3.35786798e-01,
            -5.36748334e-02,
        ],
        [
            1.23127703e-02,
            2.43964964e-02,
            4.94251630e-02,
            2.92385966e-02,
            -6.85544915e-02,
            -4.81161991e-03,
            -6.58868391e-02,
            -1.36236771e-01,
            1.10905595e-01,
            -1.96313485e-01,
            -1.36236771e-01,
            1.10905595e-01,
            -1.96313485e-01,
        ],
        [
            1.26540632e-01,
            4.94251630e-02,
            7.35080382e-01,
            2.17605705e-01,
            -4.73050868e-01,
            -2.43117965e-02,
            -4.49484243e-01,
            -1.49148407e00,
            1.07075433e00,
            -3.26736274e-01,
            -1.49148407e00,
            1.07075433e00,
            -3.26736274e-01,
        ],
        [
            1.66438320e-02,
            2.92385966e-02,
            2.17605705e-01,
            4.77040868e01,
            -4.62073021e00,
            -7.41081955e-02,
            -1.05978032e-01,
            -3.85341014e-01,
            2.24366555e-01,
            -2.45760756e-01,
            -3.85341014e-01,
            2.24366555e-01,
            -2.45760756e-01,
        ],
        [
            -1.55823978e-01,
            -6.85544915e-02,
            -4.73050868e-01,
            -4.62073021e00,
            5.75491300e00,
            -1.65759661e-01,
            5.01114117e-01,
            1.25682877e00,
            -1.10238968e00,
            4.32855406e-01,
            1.25682877e00,
            -1.10238968e00,
            4.32855406e-01,
        ],
        [
            7.34011557e-02,
            -4.81161991e-03,
            -2.43117965e-02,
            -7.41081955e-02,
            -1.65759661e-01,
            4.78270593e01,
            4.35891671e00,
            -2.15538356e-01,
            3.57233234e-01,
            1.31027358e-01,
            -2.15538356e-01,
            3.57233234e-01,
            1.31027358e-01,
        ],
        [
            -1.46387797e-01,
            -6.58868391e-02,
            -4.49484243e-01,
            -1.05978032e-01,
            5.01114117e-01,
            4.35891671e00,
            5.69776609e00,
            1.18923791e00,
            -1.03963112e00,
            4.19649784e-01,
            1.18923791e00,
            -1.03963112e00,
            4.19649784e-01,
        ],
        [
            -3.61205434e-01,
            -1.36236771e-01,
            -1.49148407e00,
            -3.85341014e-01,
            1.25682877e00,
            -2.15538356e-01,
            1.18923791e00,
            5.97072758e00,
            -8.83558139e00,
            5.94379207e00,
            3.42633990e00,
            -2.73843547e00,
            8.42658986e-01,
        ],
        [
            3.35786798e-01,
            1.10905595e-01,
            1.07075433e00,
            2.24366555e-01,
            -1.10238968e00,
            3.57233234e-01,
            -1.03963112e00,
            -8.83558139e00,
            2.11513087e01,
            -1.92333659e01,
            -2.73843547e00,
            2.36799784e00,
            -6.24263517e-01,
        ],
        [
            -5.36748334e-02,
            -1.96313485e-01,
            -3.26736274e-01,
            -2.45760756e-01,
            4.32855406e-01,
            1.31027358e-01,
            4.19649784e-01,
            5.94379207e00,
            -1.92333659e01,
            1.96394233e02,
            8.42658986e-01,
            -6.24263517e-01,
            1.62854685e00,
        ],
        [
            -3.61205434e-01,
            -1.36236771e-01,
            -1.49148407e00,
            -3.85341014e-01,
            1.25682877e00,
            -2.15538356e-01,
            1.18923791e00,
            3.42633990e00,
            -2.73843547e00,
            8.42658986e-01,
            5.97072758e00,
            -8.83558139e00,
            5.94379207e00,
        ],
        [
            3.35786798e-01,
            1.10905595e-01,
            1.07075433e00,
            2.24366555e-01,
            -1.10238968e00,
            3.57233234e-01,
            -1.03963112e00,
            -2.73843547e00,
            2.36799784e00,
            -6.24263517e-01,
            -8.83558139e00,
            2.11513087e01,
            -1.92333659e01,
        ],
        [
            -5.36748334e-02,
            -1.96313485e-01,
            -3.26736274e-01,
            -2.45760756e-01,
            4.32855406e-01,
            1.31027358e-01,
            4.19649784e-01,
            8.42658986e-01,
            -6.24263517e-01,
            1.62854685e00,
            5.94379207e00,
            -1.92333659e01,
            1.96394233e02,
        ],
    ]
    np.testing.assert_almost_equal(
        evaluate(brbd, model.mass_matrix, q=q, inverse=True), inverse_matrix_reference, decimal=6
    )
    if brbd.backend == brbd.CASADI:
        with pytest.raises(
            RuntimeError,
            match="The 'mass_matrix' method without setting q cannot be called when using the CasADi backend",
        ):
            model.mass_matrix(inverse=True)
    else:
        np.testing.assert_almost_equal(model.mass_matrix(inverse=True), inverse_matrix_reference, decimal=6)


if __name__ == "__main__":
    for brbd in brbd_to_test:
        test_wrapper_model(brbd)
